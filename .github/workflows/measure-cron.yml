name: Measure Cron Delay

on:
  schedule:
    # 1️⃣ 18:55〜19:05 JST 毎分 → UTC 09:55〜10:05
    - cron: "55 9 7 12 *"
    - cron: "56 9 7 12 *"
    - cron: "57 9 7 12 *"
    - cron: "58 9 7 12 *"
    - cron: "59 9 7 12 *"
    - cron: "0 10 7 12 *"
    - cron: "1 10 7 12 *"
    - cron: "2 10 7 12 *"
    - cron: "3 10 7 12 *"
    - cron: "4 10 7 12 *"
    - cron: "5 10 7 12 *"

    # 2️⃣ 19:05〜20:00 JST 5分おき → UTC 10:05〜11:00, exclude 10:00
    - cron: "10 10 7 12 *"
    - cron: "15 10 7 12 *"
    - cron: "20 10 7 12 *"
    - cron: "25 10 7 12 *"
    - cron: "30 10 7 12 *"
    - cron: "35 10 7 12 *"
    - cron: "40 10 7 12 *"
    - cron: "45 10 7 12 *"
    - cron: "50 10 7 12 *"
    - cron: "55 10 7 12 *"
    - cron: "0 11 7 12 *"
    - cron: "5 11 7 12 *"
    - cron: "10 11 7 12 *"
    - cron: "15 11 7 12 *"
    - cron: "20 11 7 12 *"
    - cron: "25 11 7 12 *"
    - cron: "30 11 7 12 *"
    - cron: "35 11 7 12 *"
    - cron: "40 11 7 12 *"
    - cron: "45 11 7 12 *"
    - cron: "50 11 7 12 *"
    - cron: "55 11 7 12 *"

    # 3️⃣ Every hour at minute 0 JST → UTC 09:00, 10:00, 11:00
    - cron: "0 0 7 12 *"

jobs:
  print-execution-time:
    runs-on: ubuntu-latest

    steps:
      - name: Print execution time and delay
        run: |
          echo "Scheduled cron: ${{ github.event.schedule }}"

          # extract scheduled minutes/hour from cron
          CRON="${{ github.event.schedule }}"
          S_MIN=$(echo "$CRON" | awk '{print $1}')
          S_HOUR=$(echo "$CRON" | awk '{print $2}')

          # build scheduled timestamp for today (UTC)
          SCHEDULED_UTC=$(date -u -d "$(date -u +%Y-%m-%d) $S_HOUR:$S_MIN:00" '+%Y-%m-%d %H:%M:%S')

          # actual timestamp (UTC)
          ACTUAL_UTC=$(date -u '+%Y-%m-%d %H:%M:%S')

          # compute delay in seconds
          DELAY_SECONDS=$(( $(date -u -d "$ACTUAL_UTC" +%s) - $(date -u -d "$SCHEDULED_UTC" +%s) ))

          # convert to minutes (with 1 decimal place)
          DELAY_MINUTES=$(printf "%.1f" "$(echo "$DELAY_SECONDS / 60" | bc -l)")

          echo "Scheduled time (UTC): $SCHEDULED_UTC"
          echo "Actual time (UTC):    $ACTUAL_UTC"
          echo "Delay: ${DELAY_SECONDS} sec (${DELAY_MINUTES} min)"

          echo "Actual time (JST): $(TZ='Asia/Tokyo' date '+%Y-%m-%d %H:%M:%S')"
